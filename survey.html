<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Health Anxiety & Hypochondria Study</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f5f7fa; color: #333; }
  h1, h2 { color: #2c3e50; }
  .section { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; display: none; }
  .active { display: block; }
  .progress-bar { height: 8px; background: #ddd; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
  .progress { height: 100%; width: 0%; background: #3498db; transition: width 0.3s; }
  img.doctor-img { width: 300px; height: 300px; object-fit: cover; display: block; margin: 20px auto; border-radius: 8px; border: 2px solid #3498db; }
  .rating-scale { display: flex; justify-content: space-between; max-width: 300px; margin: 10px auto; }
  .rating-btn { padding: 8px 12px; border: none; border-radius: 6px; background: #3498db; color: #fff; cursor: pointer; }
  .rating-btn.selected { background: #e74c3c; }
  input, select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px; }
  button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #2ecc71; color: #fff; margin-top: 10px; }
</style>
</head>
<body>

<div class="progress-bar"><div id="progress" class="progress"></div></div>

<div id="photo-section" class="section active">
  <h2>First Impressions of Doctors</h2>
  <img id="doctor-photo" class="doctor-img" alt="Doctor photo">
  <p>Overall trust (1 = low, 5 = high)</p>
  <div class="rating-scale" id="overallTrust">
    <button class="rating-btn" data-val="1">1</button>
    <button class="rating-btn" data-val="2">2</button>
    <button class="rating-btn" data-val="3">3</button>
    <button class="rating-btn" data-val="4">4</button>
    <button class="rating-btn" data-val="5">5</button>
  </div>
  <div>
    <label for="oneWord">First word that comes to mind</label>
    <input type="text" id="oneWord" maxlength="24" placeholder="e.g., Professional">
  </div>
  <button id="next-photo">Next</button>
</div>

<div id="quiz-section" class="section">
  <h2>Mental Health Questionnaire</h2>
  <p>Answer the following questions (1 = Never, 5 = Always)</p>
  <div id="quiz-items" class="quiz"></div>
  <button id="submit-survey">Submit Survey</button>
</div>

<div id="thankyou-section" class="section">
  <h2>Thank You!</h2>
  <p>Your responses have been recorded.</p>
</div>

<script>
const GOOGLE_APPS_SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzHgOSpJQgxStd8df1nMGgMO5gxM9F_h7xW9gWr3dK7Cwm3_y2BMiSs1OJaRi3rGKOfvA/exec"; // Replace this with “Anyone” URL

const doctorPhotos = [ /* your photo URLs */ ];
const mentalHealthQuestions = [ /* your 10 questions */ ];

let photoIndex = 0;
let surveyData = { photos: [], quiz: [], uid: Date.now(), startedAt: new Date().toISOString() };

const doctorPhotoEl = document.getElementById("doctor-photo");
const oneWordEl = document.getElementById("oneWord");
const overallTrustEl = document.getElementById("overallTrust");
const quizItemsEl = document.getElementById("quiz-items");
const progressBar = document.getElementById("progress");
const sections = {
  photo: document.getElementById("photo-section"),
  quiz: document.getElementById("quiz-section"),
  thanks: document.getElementById("thankyou-section")
};

let overallTrust = null;
overallTrustEl.addEventListener("click", e => {
  const btn = e.target.closest(".rating-btn");
  if (!btn) return;
  Array.from(overallTrustEl.children).forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
  overallTrust = Number(btn.dataset.val);
});

function showPhoto() {
  doctorPhotoEl.src = doctorPhotos[photoIndex];
  oneWordEl.value = "";
  Array.from(overallTrustEl.children).forEach(b => b.classList.remove("selected"));
  overallTrust = null;
  updateProgress();
}

document.getElementById("next-photo").addEventListener("click", () => {
  if (!overallTrust) { alert("Select overall trust"); return; }
  if (!oneWordEl.value.trim()) { alert("Enter a word"); return; }
  surveyData.photos.push({ photoUrl: doctorPhotos[photoIndex], overallTrust, oneWord: oneWordEl.value.trim() });
  photoIndex++;
  if (photoIndex < doctorPhotos.length) showPhoto();
  else { renderQuiz(); sections.photo.style.display="none"; sections.quiz.style.display="block"; updateProgress(); }
});

function renderQuiz() {
  quizItemsEl.innerHTML = "";
  mentalHealthQuestions.forEach((q,i) => {
    const div = document.createElement("div");
    div.className = "quiz-item";
    div.innerHTML = `<label>${i+1}. ${q}</label>
      <select id="q${i}">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option>
      </select>`;
    quizItemsEl.appendChild(div);
  });
  updateProgress();
}

document.getElementById("submit-survey").addEventListener("click", async () => {
  try {
    const answers = mentalHealthQuestions.map((q,i)=>({ question:q, answer:Number(document.getElementById(`q${i}`).value) }));
    surveyData.quiz = answers;
    surveyData.finishedAt = new Date().toISOString();

    const payloadToSend = {
      uid: surveyData.uid,
      startedAt: surveyData.startedAt,
      finishedAt: surveyData.finishedAt,
      photoResponses: surveyData.photos,
      quizAnswers: surveyData.quiz,
      userAgent: navigator.userAgent,
      consentInfo: JSON.parse(localStorage.getItem("consentInfo") || "{}")
    };

    const res = await fetch(GOOGLE_APPS_SCRIPT_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payloadToSend)
    });

    const text = await res.text();
    console.log("Response text:", text);
    if (!res.ok) throw new Error(`HTTP ${res.status} - ${text}`);

    sections.quiz.style.display="none"; sections.thanks.style.display="block"; updateProgress();

  } catch(e) {
    console.error("Submit error:", e);
    alert("Error submitting survey. Check console.");
  }
});

function updateProgress() {
  const total = doctorPhotos.length + mentalHealthQuestions.length;
  let completed = photoIndex;
  if (sections.quiz.style.display==="block") completed+=0;
  else if (sections.thanks.style.display==="block") completed=total;
  progressBar.style.width=Math.round((completed/total)*100)+"%";
}

showPhoto();
</script>
</body>
</html>
